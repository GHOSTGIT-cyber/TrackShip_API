<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ∞Ô∏è Surveillance des navires - Seine</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="assets/style.css" />
    
</head>
<body>
    <!-- Badge Hostinger -->
    <div class="hostinger-badge">üöÄ Powered by Ghost</div>
    
    <!-- Banni√®re d'alerte (ajout√©e dynamiquement) -->
    
    <!-- Compteur de rafra√Æchissement -->
    <div id="compteurRefresh" class="compteur-refresh" style="display: none;">
        Actualisation dans <span id="tempsRestant">10</span>s
    </div>

    <div class="container">
        <div class="header">
            <h1>üõ∞Ô∏è Surveillance des navires en mouvement (Seine)</h1>
            <p>trackship.bakabi.fr ‚Ä¢ API EuRIS ‚Ä¢ surveillance automatique avec alertes de proximit√©</p>
        </div>

        <div class="controls">
            <div class="form-group">
                <div>
                    <label for="token">üîë Token API EuRIS</label>
                    <input type="text" id="token" placeholder="Votre token d'acc√®s EuRIS">
                </div>
                <div>
                    <label for="latitude">üìç Latitude centre</label>
                    <input type="number" id="latitude" value="48.853229" step="0.000001">
                </div>
                <div>
                    <label for="longitude">üìç Longitude centre</label>
                    <input type="number" id="longitude" value="2.225328" step="0.000001">
                </div>
                <div>
                    <label for="rayon">üìè Rayon (km)</label>
                    <input type="number" id="rayon" value="3" min="1" max="50">
                </div>
                <div>
                    <label for="filtreNavires">üö¢ Type de navires</label>
                    <select id="filtreNavires">
                        <option value="tous">Tous les navires</option>
                        <option value="mouvement">En mouvement uniquement</option>
                        <option value="arret">√Ä l'arr√™t uniquement</option>
                    </select>
                </div>
                <div>
                    <button class="btn" id="btnSurveillance" onclick="demarrerSurveillance()">üîç D√©marrer la surveillance</button>
                </div>
            </div>
            
            <!-- Indicateur de statut -->
            <div id="statusIndicator" class="status-indicator" style="display: none;">
                <span id="statusText">Pr√™t</span>
            </div>
        </div>

        <div class="content">
            <div class="map-container">
                <div id="map"></div>
            </div>
            
            <div class="sidebar">
                <div class="stats">
                    <h3>üìä Statistiques</h3>
                    <div class="stat-item">
                        <span class="stat-label">Navires d√©tect√©s</span>
                        <span class="stat-value" id="totalNavires">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">üü¢ Zone d'approche (3km)</span>
                        <span class="stat-value" id="naviresApproche">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">üü† Zone vigilance (2km)</span>
                        <span class="stat-value" id="naviresVigilance">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">üî¥ Zone alerte (1km)</span>
                        <span class="stat-value" id="naviresAlerte">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Derni√®re MAJ</span>
                        <span class="stat-value" id="derniereMaj">Jamais</span>
                    </div>
                </div>

                <div class="navires-list">
                    <h3>üö¢ Navires surveill√©s</h3>
                    <div id="listeNavires" class="loading">
                        Cliquez sur "D√©marrer la surveillance" pour commencer...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Configuration de la base de surveillance
        const BASE_COORDS = {
            lat: 48.853229,
            lon: 2.225328
        };

        // Zones de surveillance (en m√®tres)
        const ZONES_BASE = {
            ALERTE: 1000,       // 1km - zone d'alerte (rouge)
            VIGILANCE: 2000,    // 2km - zone de vigilance (orange)
            APPROCHE: 3000      // 3km - zone d'approche (vert)
        };

        // Variables globales
        let map;
        let navires = [];
        let markers = [];
        let cercles = [];
        let baseMarker;
        let surveillanceActive = false;
        let intervalleRefresh;
        let intervalleCompteur;
        let tempsRestant = 10;
        let naviresEnAlerte = new Set();
        let coordsActuelles = {...BASE_COORDS};

        console.log('üö¢ TrackShip charg√© sur trackship.bakabi.fr');

        // Affichage du statut de connexion
        function afficherStatut(type, message) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            indicator.style.display = 'block';
            indicator.className = `status-indicator status-${type}`;
            text.textContent = message;
            
            console.log(`üìä Statut: ${type} - ${message}`);
        }

        // Affichage des messages dans la liste des navires
        function afficherMessage(type, titre, message, details = null) {
            const listeElement = document.getElementById('listeNavires');
            
            let detailsHtml = '';
            if (details) {
                if (typeof details === 'object') {
                    detailsHtml = `<div style="margin-top: 10px; font-size: 12px; color: #666;"><pre>${JSON.stringify(details, null, 2)}</pre></div>`;
                } else {
                    detailsHtml = `<div style="margin-top: 10px; font-size: 12px; color: #666;">${details}</div>`;
                }
            }
            
            listeElement.innerHTML = `
                <div class="${type}">
                    <strong>${titre}</strong><br>
                    ${message}
                    ${detailsHtml}
                </div>
            `;
        }

        // Initialisation de la carte
        function initMap() {
            console.log('üó∫Ô∏è Initialisation de la carte Leaflet');
            
            map = L.map('map').setView([coordsActuelles.lat, coordsActuelles.lon], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            mettreAJourBase();
            console.log('‚úÖ Carte initialis√©e avec les zones de surveillance');
        }

        // Mise √† jour de la base et des cercles
        function mettreAJourBase() {
            if (baseMarker) {
                map.removeLayer(baseMarker);
            }
            
            cercles.forEach(cercle => map.removeLayer(cercle));
            cercles = [];

            // Marqueur de base (avec image personnalisable)
            const imageUrl = 'assets/1.png';
            
            const baseIcon = L.icon({
                iconUrl: imageUrl,
                iconSize: [32, 32],
                iconAnchor: [16, 16],
                popupAnchor: [0, -16]
            });
            
            const fallbackIcon = L.divIcon({
                html: 'üè≠',
                iconSize: [30, 30],
                className: 'base-marker'
            });
            
            baseMarker = L.marker([coordsActuelles.lat, coordsActuelles.lon], {icon: baseIcon})
                .addTo(map)
                .bindPopup('<b>üè≠ Base de surveillance</b><br>trackship.bakabi.fr');
            
            baseMarker.on('error', function() {
                baseMarker.setIcon(fallbackIcon);
            });

            // Calcul des rayons
            const rayonSaisi = parseFloat(document.getElementById('rayon').value) || 5;
            let rayons = {...ZONES_BASE};
            
            if (rayonSaisi > 3) {
                const facteur = rayonSaisi / 3;
                rayons.ALERTE = ZONES_BASE.ALERTE * facteur;
                rayons.VIGILANCE = ZONES_BASE.VIGILANCE * facteur;
                rayons.APPROCHE = ZONES_BASE.APPROCHE * facteur;
            }

            // Zone d'alerte (1km) - rouge
            const cercleAlerte = L.circle([coordsActuelles.lat, coordsActuelles.lon], {
                color: '#dc3545',
                fillColor: '#dc3545',
                fillOpacity: 0.2,
                radius: rayons.ALERTE,
                weight: 3
            }).addTo(map).bindPopup(`Zone d'alerte (${Math.round(rayons.ALERTE/1000*10)/10}km)`);
            cercles.push(cercleAlerte);

            // Zone de vigilance (2km) - orange
            const cercleVigilance = L.circle([coordsActuelles.lat, coordsActuelles.lon], {
                color: '#fd7e14',
                fillColor: '#fd7e14',
                fillOpacity: 0.15,
                radius: rayons.VIGILANCE,
                weight: 2
            }).addTo(map).bindPopup(`Zone de vigilance (${Math.round(rayons.VIGILANCE/1000*10)/10}km)`);
            cercles.push(cercleVigilance);

            // Zone d'approche (3km) - vert
            const cercleApproche = L.circle([coordsActuelles.lat, coordsActuelles.lon], {
                color: '#28a745',
                fillColor: '#28a745',
                fillOpacity: 0.1,
                radius: rayons.APPROCHE,
                weight: 2,
                dashArray: '5, 5'
            }).addTo(map).bindPopup(`Zone d'approche (${Math.round(rayons.APPROCHE/1000*10)/10}km)`);
            cercles.push(cercleApproche);

            // Zone de surveillance g√©n√©rale si > 3km
            if (rayonSaisi > 3) {
                const cercleSurveillance = L.circle([coordsActuelles.lat, coordsActuelles.lon], {
                    color: '#6c757d',
                    fillColor: 'transparent',
                    fillOpacity: 0,
                    radius: rayonSaisi * 1000,
                    weight: 1,
                    dashArray: '10, 10'
                }).addTo(map).bindPopup(`Zone de surveillance g√©n√©rale (${rayonSaisi}km)`);
                cercles.push(cercleSurveillance);
            }
        }

        // Calcul de la distance (formule de Haversine)
        function calculerDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // V√©rification si navire en mouvement
        function estEnMouvement(navire) {
            const vitesse = parseFloat(navire.speed) || 0;
            return vitesse > 0.5;
        }

        // Analyse du niveau de danger
        function analyserNavire(navire) {
            const distance = calculerDistance(
                coordsActuelles.lat, coordsActuelles.lon,
                navire.latitude, navire.longitude
            );

            const rayonSaisi = parseFloat(document.getElementById('rayon').value) || 5;
            let rayons = {...ZONES_BASE};
            
            if (rayonSaisi > 3) {
                const facteur = rayonSaisi / 3;
                rayons.ALERTE = ZONES_BASE.ALERTE * facteur;
                rayons.VIGILANCE = ZONES_BASE.VIGILANCE * facteur;
                rayons.APPROCHE = ZONES_BASE.APPROCHE * facteur;
            }

            let statut = 'approche';
            let couleur = '#28a745';
            let emoji = '';
            let classeCSS = 'navire-normal';
            let classeDistance = 'distance-normal';

            if (distance <= rayons.ALERTE) {
                statut = 'alerte';
                couleur = '#dc3545';
                emoji = 'üö®';
                classeCSS = 'navire-alerte';
                classeDistance = 'distance-alerte';
            } else if (distance <= rayons.VIGILANCE) {
                statut = 'vigilance';
                couleur = '#fd7e14';
                emoji = '‚ö†Ô∏è';
                classeCSS = 'navire-vigilance';
                classeDistance = 'distance-vigilance';
            }

            return {
                distance: Math.round(distance),
                statut,
                couleur,
                emoji,
                classeCSS,
                classeDistance
            };
        }

        // Panneau d'attention pour navires en mouvement < 2km
        function afficherPanneauAttention(naviresVigilance) {
            const panneauExistant = document.getElementById('panneauAttention');
            if (panneauExistant) {
                panneauExistant.remove();
            }

            const naviresEnMouvementVigilance = naviresVigilance.filter(navire => estEnMouvement(navire));

            if (naviresEnMouvementVigilance.length === 0) return;

            console.log('‚ö†Ô∏è Panneau attention pour', naviresEnMouvementVigilance.length, 'navire(s) en mouvement');
            
            const panneau = document.createElement('div');
            panneau.id = 'panneauAttention';
            panneau.className = 'panneau-attention';
            
            let contenuPanneau = `
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <span style="font-size: 24px; margin-right: 10px;">üü†</span>
                    <strong>NAVIRES EN MOUVEMENT - ZONE 2KM</strong>
                </div>
            `;
            
            naviresEnMouvementVigilance.forEach(navire => {
                const analyse = analyserNavire(navire);
                contenuPanneau += `
                    <div class="navire-panneau">
                        <div style="font-size: 16px; margin-bottom: 5px;">
                            <strong>"${navire.shipName || 'Inconnu'}"</strong> üîÑ
                        </div>
                        <div style="font-size: 14px; opacity: 0.9;">
                            Distance: <strong>${analyse.distance}m</strong><br>
                            Vitesse: <strong>${navire.speed || 'N/A'} kn</strong><br>
                            Longueur: <strong>${navire.length || 'N/A'} m</strong>
                        </div>
                    </div>
                `;
            });
            
            panneau.innerHTML = contenuPanneau;
            document.body.appendChild(panneau);
            
            setTimeout(() => {
                if (document.getElementById('panneauAttention')) {
                    panneau.remove();
                }
            }, 8000);
        }

        // Alerte rouge pour navires en mouvement < 1km
        function declencherAlerteRouge(navire) {
            console.log('üö® Alerte rouge pour navire en mouvement:', navire.shipName);
            
            const ancienneBanniere = document.getElementById('banniereAlerte');
            if (ancienneBanniere) {
                ancienneBanniere.remove();
            }

            const analyse = analyserNavire(navire);
            
            const banniere = document.createElement('div');
            banniere.id = 'banniereAlerte';
            banniere.className = 'banniere-alerte';
            banniere.innerHTML = `
                üö® ALERTE ZONE 1KM üö® - Navire en mouvement "${navire.shipName || 'Inconnu'}" ! 
                Distance: ${analyse.distance}m - Vitesse: ${navire.speed || 'N/A'} kn
            `;
            
            document.body.insertBefore(banniere, document.body.firstChild);
            
            setTimeout(() => {
                if (document.getElementById('banniereAlerte')) {
                    banniere.remove();
                }
            }, 10000);

            // Notification sonore
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('üîá Notification sonore non disponible');
            }
        }

        // Filtrage des navires
        function filtrerNavires(navires) {
            const filtre = document.getElementById('filtreNavires').value;
            
            switch (filtre) {
                case 'mouvement':
                    return navires.filter(navire => estEnMouvement(navire));
                case 'arret':
                    return navires.filter(navire => !estEnMouvement(navire));
                case 'tous':
                default:
                    return navires;
            }
        }

        // Mise √† jour des marqueurs sur la carte
        function mettreAJourMarqueurs() {
            console.log('üó∫Ô∏è Mise √† jour des marqueurs');
            
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            const naviresAfficher = filtrerNavires(navires);

            naviresAfficher.forEach(navire => {
                const analyse = analyserNavire(navire);
                const enMouvement = estEnMouvement(navire);
                
                let iconeHtml = `<div style="
                    background-color: ${analyse.couleur};
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    border: 2px solid white;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 10px;
                    opacity: ${enMouvement ? '1' : '0.6'};
                ">üö¢</div>`;

                if (analyse.emoji) {
                    iconeHtml += `<span style="position: absolute; top: -10px; right: -10px; font-size: 16px;">${analyse.emoji}</span>`;
                }

                const iconeNavire = L.divIcon({
                    html: iconeHtml,
                    iconSize: [20, 20],
                    className: 'navire-marker'
                });

                const popupContent = `
                    <div style="min-width: 200px;">
                        <h4 style="margin: 0 0 10px 0; color: ${analyse.couleur};">
                            üö¢ ${navire.shipName || 'Navire inconnu'} ${analyse.emoji}
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 12px;">
                            <div><strong>Vitesse:</strong> ${navire.speed || 'N/A'} kn</div>
                            <div><strong>Longueur:</strong> ${navire.length || 'N/A'} m</div>
                            <div><strong>MMSI:</strong> ${navire.mmsi || 'N/A'}</div>
                            <div><strong>Type:</strong> ${navire.shipType || 'N/A'}</div>
                            <div><strong>Distance:</strong> ${analyse.distance}m</div>
                            <div><strong>Statut:</strong> <span style="color: ${analyse.couleur}; font-weight: bold;">${enMouvement ? 'EN MOUVEMENT' : '√Ä L\'ARR√äT'}</span></div>
                        </div>
                        <div style="margin-top: 8px; font-size: 11px; color: #666;">
                            üìç ${navire.latitude?.toFixed(6)}, ${navire.longitude?.toFixed(6)}
                        </div>
                    </div>
                `;

                const marker = L.marker([navire.latitude, navire.longitude], {icon: iconeNavire})
                    .addTo(map)
                    .bindPopup(popupContent);
                
                markers.push(marker);
            });

            console.log(`‚úÖ ${markers.length} marqueurs ajout√©s`);
        }

        // Mise √† jour de la liste des navires
        function mettreAJourListeNavires() {
            console.log('üìã Mise √† jour de la liste des navires');
            
            const listeElement = document.getElementById('listeNavires');
            const naviresAfficher = filtrerNavires(navires);
            
            if (naviresAfficher.length === 0) {
                const filtre = document.getElementById('filtreNavires').value;
                let message = 'Aucun navire d√©tect√© dans la zone';
                if (filtre === 'mouvement') {
                    message = 'Aucun navire en mouvement d√©tect√©';
                } else if (filtre === 'arret') {
                    message = 'Aucun navire √† l\'arr√™t d√©tect√©';
                }
                listeElement.innerHTML = `<div class="loading">${message}</div>`;
                return;
            }

            // Tri par distance
            const naviresTries = [...naviresAfficher].sort((a, b) => {
                const distA = calculerDistance(coordsActuelles.lat, coordsActuelles.lon, a.latitude, a.longitude);
                const distB = calculerDistance(coordsActuelles.lat, coordsActuelles.lon, b.latitude, b.longitude);
                return distA - distB;
            });

            const htmlNavires = naviresTries.map(navire => {
                const analyse = analyserNavire(navire);
                const enMouvement = estEnMouvement(navire);
                
                return `
                    <div class="navire-item ${analyse.classeCSS}" onclick="centrerSurNavire(${navire.latitude}, ${navire.longitude})">
                        <div class="navire-header">
                            <span class="navire-nom">
                                üö¢ ${navire.shipName || 'Navire inconnu'} ${analyse.emoji}
                                ${enMouvement ? 'üîÑ' : '‚è∏Ô∏è'}
                            </span>
                            <span class="navire-distance ${analyse.classeDistance}">
                                ${analyse.distance}m
                            </span>
                        </div>
                        <div class="navire-details">
                            <div class="navire-detail">
                                <span>Vitesse:</span>
                                <strong>${navire.speed || 'N/A'} kn</strong>
                            </div>
                            <div class="navire-detail">
                                <span>Longueur:</span>
                                <strong>${navire.length || 'N/A'} m</strong>
                            </div>
                            <div class="navire-detail">
                                <span>MMSI:</span>
                                <strong>${navire.mmsi || 'N/A'}</strong>
                            </div>
                            <div class="navire-detail">
                                <span>Type:</span>
                                <strong>${navire.shipType || 'N/A'}</strong>
                            </div>
                            <div class="navire-detail">
                                <span>Statut:</span>
                                <strong>${enMouvement ? 'En mouvement' : '√Ä l\'arr√™t'}</strong>
                            </div>
                            <div class="navire-detail">
                                <span>Distance base:</span>
                                <strong>${analyse.distance}m</strong>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            listeElement.innerHTML = htmlNavires;
        }

        // Centrage sur navire
        function centrerSurNavire(lat, lon) {
            console.log(`üéØ Centrage sur navire: ${lat}, ${lon}`);
            map.setView([lat, lon], 15);
        }

        // Mise √† jour des statistiques
        function mettreAJourStatistiques() {
            const naviresAfficher = filtrerNavires(navires);
            let approche = 0, vigilance = 0, alerte = 0;
            
            naviresAfficher.forEach(navire => {
                const analyse = analyserNavire(navire);
                switch(analyse.statut) {
                    case 'approche': approche++; break;
                    case 'vigilance': vigilance++; break;
                    case 'alerte': alerte++; break;
                }
            });

            document.getElementById('totalNavires').textContent = naviresAfficher.length;
            document.getElementById('naviresApproche').textContent = approche;
            document.getElementById('naviresVigilance').textContent = vigilance;
            document.getElementById('naviresAlerte').textContent = alerte;
            document.getElementById('derniereMaj').textContent = new Date().toLocaleTimeString('fr-FR');
        }

        // Gestion des alertes
        function gererAlertes() {
            const naviresAfficher = filtrerNavires(navires);
            
            const naviresZoneAlerte = naviresAfficher.filter(navire => {
                const analyse = analyserNavire(navire);
                return analyse.statut === 'alerte';
            });
            
            const naviresZoneVigilance = naviresAfficher.filter(navire => {
                const analyse = analyserNavire(navire);
                return analyse.statut === 'vigilance' || analyse.statut === 'alerte';
            });
            
            const naviresAlerteMouvement = naviresZoneAlerte.filter(navire => estEnMouvement(navire));
            
            // Panneau orange : navires EN MOUVEMENT dans zone 2km
            if (naviresZoneVigilance.length > 0) {
                afficherPanneauAttention(naviresZoneVigilance);
            }
            
            // Banni√®re rouge : navires EN MOUVEMENT dans zone 1km
            if (naviresAlerteMouvement.length > 0) {
                naviresAlerteMouvement.forEach(navire => {
                    if (!naviresEnAlerte.has(navire.mmsi)) {
                        declencherAlerteRouge(navire);
                        naviresEnAlerte.add(navire.mmsi);
                    }
                });
            }
            
            // Nettoyage des navires plus en alerte
            const mmsiActuels = new Set(naviresAlerteMouvement.map(n => n.mmsi));
            naviresEnAlerte.forEach(mmsi => {
                if (!mmsiActuels.has(mmsi)) {
                    naviresEnAlerte.delete(mmsi);
                }
            });
        }

        // *** MODIFICATION PRINCIPALE : URL API CHANG√âE ***
        async function recupererNavires() {
            console.log('üîÑ R√©cup√©ration des navires depuis EuRIS...');
            
            const token = document.getElementById('token').value;
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            const rayon = parseFloat(document.getElementById('rayon').value);

            if (!token) {
                throw new Error('Token API requis');
            }

            if (isNaN(lat) || isNaN(lon) || isNaN(rayon)) {
                throw new Error('Coordonn√©es invalides');
            }

            coordsActuelles.lat = lat;
            coordsActuelles.lon = lon;

            const kmToDegrees = rayon / 111;
            const minLat = lat - kmToDegrees;
            const maxLat = lat + kmToDegrees;
            const minLon = lon - (kmToDegrees / Math.cos(lat * Math.PI / 180));
            const maxLon = lon + (kmToDegrees / Math.cos(lat * Math.PI / 180));

            const params = new URLSearchParams({
                minLat: minLat.toString(),
                maxLat: maxLat.toString(),
                minLon: minLon.toString(),
                maxLon: maxLon.toString(),
                pageSize: '100'
            });

            // *** URL MODIFI√âE POUR HOSTINGER ***
            const url = `api/euris-proxy.php?${params.toString()}`;
            
            console.log('üåê URL appel√©e:', url);
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });
            
            console.log('üì° R√©ponse re√ßue - Status:', response.status);
            
            if (!response.ok) {
                let errorMessage = `Erreur HTTP ${response.status}: ${response.statusText}`;
                let errorDetails = null;
                
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error || errorMessage;
                    errorDetails = errorData;
                    console.error('‚ùå D√©tails de l\'erreur:', errorData);
                } catch (e) {
                    console.error('‚ùå Impossible de parser l\'erreur JSON');
                    const errorText = await response.text();
                    errorDetails = errorText;
                    console.error('‚ùå R√©ponse d\'erreur (texte):', errorText);
                }
                
                const error = new Error(errorMessage);
                error.details = errorDetails;
                error.status = response.status;
                throw error;
            }

            const data = await response.json();
            console.log('üìä Donn√©es re√ßues:', data);
            
            if (!data) {
                throw new Error('R√©ponse vide de l\'API');
            }

            let naviresData = [];
            if (data.tracks && Array.isArray(data.tracks)) {
                naviresData = data.tracks;
            } else if (Array.isArray(data)) {
                naviresData = data;
            } else if (data.data && Array.isArray(data.data)) {
                naviresData = data.data;
            } else {
                console.warn('‚ö†Ô∏è Aucun tableau de navires trouv√© dans la r√©ponse');
                naviresData = [];
            }

            const naviresFiltr√©s = naviresData.filter(navire => {
                if (!navire || typeof navire.latitude !== 'number' || typeof navire.longitude !== 'number') {
                    console.warn('‚ö†Ô∏è Navire sans coordonn√©es valides:', navire);
                    return false;
                }
                
                const distance = calculerDistance(lat, lon, navire.latitude, navire.longitude);
                return distance <= (rayon * 1000);
            });

            console.log(`‚úÖ ${naviresFiltr√©s.length} navires dans la zone de ${rayon}km apr√®s filtrage`);
            return naviresFiltr√©s;
        }

        // Mise √† jour compl√®te des donn√©es
        async function mettreAJourDonnees() {
            try {
                console.log('üîÑ D√©but de la mise √† jour des donn√©es');
                afficherStatut('connecting', 'Connexion √† l\'API EuRIS...');
                
                navires = await recupererNavires();
                
                console.log(`üìä ${navires.length} navires r√©cup√©r√©s`);
                
                mettreAJourBase();
                map.setView([coordsActuelles.lat, coordsActuelles.lon], map.getZoom());
                
                mettreAJourMarqueurs();
                mettreAJourListeNavires();
                mettreAJourStatistiques();
                gererAlertes();
                
                const naviresAfficher = filtrerNavires(navires);
                if (naviresAfficher.length > 0) {
                    afficherStatut('connected', `${naviresAfficher.length} navires surveill√©s`);
                } else {
                    afficherStatut('connected', 'Aucun navire dans la zone');
                    afficherMessage('info', 'Zone claire', 'Aucun navire d√©tect√© dans la zone de surveillance.');
                }
                
                console.log('‚úÖ Mise √† jour termin√©e avec succ√®s');
                
            } catch (error) {
                console.error('‚ùå Erreur lors de la mise √† jour:', error);
                
                afficherStatut('error', 'Erreur de connexion');
                
                let messageErreur = error.message;
                let details = null;
                
                if (error.details) {
                    details = error.details;
                }
                
                if (error.status) {
                    switch (error.status) {
                        case 401:
                            messageErreur = 'Token d\'authentification invalide ou expir√©';
                            break;
                        case 403:
                            messageErreur = 'Acc√®s interdit - permissions insuffisantes';
                            break;
                        case 404:
                            messageErreur = 'Service EuRIS non trouv√©';
                            break;
                        case 429:
                            messageErreur = 'Trop de requ√™tes - attendez avant de r√©essayer';
                            break;
                        case 500:
                        case 502:
                        case 503:
                        case 504:
                            messageErreur = 'Service EuRIS temporairement indisponible';
                            break;
                    }
                }
                
                afficherMessage('error', 'Erreur de r√©cup√©ration', messageErreur, details);
            }
        }

        // Gestion du compteur de rafra√Æchissement
        function demarrerCompteur() {
            const compteurElement = document.getElementById('compteurRefresh');
            const tempsElement = document.getElementById('tempsRestant');
            
            compteurElement.style.display = 'block';
            
            intervalleCompteur = setInterval(() => {
                tempsElement.textContent = tempsRestant;
                tempsRestant--;
                
                if (tempsRestant < 0) {
                    tempsRestant = 10;
                    mettreAJourDonnees();
                }
            }, 1000);
        }

        // Arr√™t de la surveillance
        function arreterSurveillance() {
            console.log('‚èπÔ∏è Arr√™t de la surveillance');
            
            surveillanceActive = false;
            
            if (intervalleRefresh) {
                clearInterval(intervalleRefresh);
            }
            if (intervalleCompteur) {
                clearInterval(intervalleCompteur);
            }
            
            document.getElementById('compteurRefresh').style.display = 'none';
            
            const btn = document.getElementById('btnSurveillance');
            btn.textContent = 'üîç D√©marrer la surveillance';
            btn.disabled = false;
            
            document.getElementById('statusIndicator').style.display = 'none';
            
            naviresEnAlerte.clear();
            
            const banniere = document.getElementById('banniereAlerte');
            if (banniere) banniere.remove();
            
            const panneau = document.getElementById('panneauAttention');
            if (panneau) panneau.remove();
            
            document.getElementById('listeNavires').innerHTML = '<div class="loading">Cliquez sur "D√©marrer la surveillance" pour commencer...</div>';
        }

        // D√©marrage de la surveillance
        async function demarrerSurveillance() {
            console.log('üöÄ D√©marrage de la surveillance automatique');
            
            const btn = document.getElementById('btnSurveillance');
            
            if (surveillanceActive) {
                arreterSurveillance();
                return;
            }
            
            const token = document.getElementById('token').value.trim();
            if (!token) {
                alert('Veuillez saisir votre token API EuRIS');
                return;
            }
            
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            const rayon = parseFloat(document.getElementById('rayon').value);
            
            if (isNaN(lat) || isNaN(lon) || isNaN(rayon)) {
                alert('Veuillez v√©rifier les coordonn√©es et le rayon');
                return;
            }
            
            if (rayon < 3) {
                alert('Le rayon minimum est de 3 km');
                return;
            }
            
            try {
                btn.textContent = '‚èπÔ∏è Arr√™ter la surveillance';
                btn.disabled = true;
                
                await mettreAJourDonnees();
                
                surveillanceActive = true;
                btn.disabled = false;
                
                tempsRestant = 10;
                demarrerCompteur();
                
                console.log('‚úÖ Surveillance d√©marr√©e - Actualisation toutes les 10 secondes');
                
            } catch (error) {
                console.error('‚ùå Erreur lors du d√©marrage:', error);
                
                btn.textContent = 'üîç D√©marrer la surveillance';
                btn.disabled = false;
                
                let messageErreur = error.message;
                if (error.status === 401) {
                    messageErreur = 'Token invalide. V√©rifiez votre token API EuRIS.';
                } else if (error.status === 403) {
                    messageErreur = 'Acc√®s refus√©. V√©rifiez les permissions de votre token.';
                }
                
                alert('Erreur lors du d√©marrage de la surveillance:\n' + messageErreur);
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üåü Initialisation de l\'application TrackShip');
            initMap();
            
            window.addEventListener('beforeunload', function() {
                if (surveillanceActive) {
                    arreterSurveillance();
                }
            });
            
            console.log('‚úÖ Application initialis√©e et pr√™te sur trackship.bakabi.fr');
        });
    </script>
</body>
</html>