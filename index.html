<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🛰️ Surveillance des navires - Seine</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }

        /* Bannière d'alerte rouge pour les navires à 2km */
        .banniere-alerte {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(45deg, #ff0000, #cc0000);
            color: white;
            text-align: center;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            animation: pulse-alert 1s infinite;
        }

        @keyframes pulse-alert {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }

        /* Compteur de rafraîchissement */
        .compteur-refresh {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 16px;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border: 2px solid #4CAF50;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .form-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: end;
            margin-bottom: 20px;
        }

        .form-group > div {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
        }

        .btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,123,255,0.4);
        }

        .content {
            display: flex;
            height: 800px;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .sidebar {
            width: 450px;
            background: #f8f9fa;
            border-left: 1px solid #dee2e6;
            overflow-y: auto;
            padding: 20px;
        }

        .stats {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stats h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 1.3em;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 600;
            color: #6c757d;
        }

        .stat-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .navires-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navires-list h3 {
            background: #495057;
            color: white;
            margin: 0;
            padding: 15px 20px;
            font-size: 1.2em;
        }

        .navire-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.3s ease;
        }

        .navire-item:hover {
            background-color: #f8f9fa;
        }

        .navire-item:last-child {
            border-bottom: none;
        }

        /* Styles pour les navires selon leur distance */
        .navire-normal {
            border-left: 4px solid #28a745;
        }

        .navire-danger {
            border-left: 4px solid #dc3545;
            background-color: #fff5f5;
        }

        .navire-alerte {
            border-left: 4px solid #ffc107;
            background-color: #fffbf0;
        }

        .navire-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .navire-nom {
            font-weight: bold;
            font-size: 1.1em;
            color: #495057;
        }

        .navire-distance {
            font-size: 0.9em;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        .distance-normal {
            background-color: #d4edda;
            color: #155724;
        }

        .distance-danger {
            background-color: #f8d7da;
            color: #721c24;
        }

        .distance-alerte {
            background-color: #fff3cd;
            color: #856404;
        }

        .navire-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.9em;
            color: #6c757d;
        }

        .navire-detail {
            display: flex;
            justify-content: space-between;
        }

        .navire-detail strong {
            color: #495057;
        }

        /* Icônes d'alerte */
        .emoji-danger {
            font-size: 1.5em;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            border: 1px solid #f5c6cb;
        }

        /* Panneau d'attention pour 1km */
        .panneau-attention {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
            padding: 30px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            z-index: 10001;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center;
            border: 3px solid #fff;
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-50%, -50%) rotate(-2deg); }
            75% { transform: translate(-50%, -50%) rotate(2deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
                height: auto;
            }
            
            .sidebar {
                width: 100%;
                height: 400px;
            }
            
            .form-group {
                flex-direction: column;
            }
            
            .form-group > div {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Bannière d'alerte (sera ajoutée dynamiquement) -->
    
    <!-- Compteur de rafraîchissement -->
    <div id="compteurRefresh" class="compteur-refresh" style="display: none;">
        Actualisation dans <span id="tempsRestant">10</span>s
    </div>

    <div class="container">
        <div class="header">
            <h1>🛰️ Surveillance des navires en mouvement (Seine)</h1>
            <p>API EuRIS : surveillance automatique avec alertes de proximité</p>
        </div>

        <div class="controls">
            <div class="form-group">
                <div>
                    <label for="token">🔑 Token API EuRIS</label>
                    <input type="text" id="token" placeholder="Votre token d'accès EuRIS">
                </div>
                <div>
                    <label for="latitude">📍 Latitude centre</label>
                    <input type="number" id="latitude" value="48.85309706001836" step="0.000001">
                </div>
                <div>
                    <label for="longitude">📍 Longitude centre</label>
                    <input type="number" id="longitude" value="2.224401062172619" step="0.000001">
                </div>
                <div>
                    <label for="rayon">📏 Rayon (km)</label>
                    <input type="number" id="rayon" value="5" min="1" max="50">
                </div>
                <div>
                    <button class="btn" onclick="demarrerSurveillance()">🔍 Démarrer la surveillance</button>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="map-container">
                <div id="map"></div>
            </div>
            
            <div class="sidebar">
                <div class="stats">
                    <h3>📊 Statistiques</h3>
                    <div class="stat-item">
                        <span class="stat-label">Navires détectés</span>
                        <span class="stat-value" id="totalNavires">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">🟢 Zone normale</span>
                        <span class="stat-value" id="naviresNormaux">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">🔴 Zone danger (2km)</span>
                        <span class="stat-value" id="naviresDanger">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">🟡 Zone alerte (1km)</span>
                        <span class="stat-value" id="naviresAlerte">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Dernière MAJ</span>
                        <span class="stat-value" id="derniereMaj">Jamais</span>
                    </div>
                </div>

                <div class="navires-list">
                    <h3>🚢 Navires surveillés</h3>
                    <div id="listeNavires" class="loading">
                        Cliquez sur "Démarrer la surveillance" pour commencer...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Configuration de la base de surveillance
        const BASE_COORDS = {
            lat: 48.85309706001836,
            lon: 2.224401062172619
        };

        // Zones de surveillance (en mètres)
        const ZONES = {
            SURVEILLANCE: 5000,  // 5km - zone de surveillance générale
            DANGER: 2000,        // 2km - zone de danger (changement couleur + emoji)
            ALERTE: 1000         // 1km - zone d'alerte critique (panneau attention)
        };

        // Variables globales
        let map;
        let navires = [];
        let markers = [];
        let surveillanceActive = false;
        let intervalleRefresh;
        let intervalleCompteur;
        let tempsRestant = 10;
        let naviresEnDanger = new Set(); // Pour éviter les notifications répétées

        // Initialisation de la carte
        function initMap() {
            console.log('🗺️ Initialisation de la carte Leaflet');
            
            map = L.map('map').setView([BASE_COORDS.lat, BASE_COORDS.lon], 12);
            
            // Couche de carte OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Marqueur de la base (point central de surveillance)
            const baseIcon = L.divIcon({
                html: '🏭',
                iconSize: [30, 30],
                className: 'base-marker'
            });
            
            L.marker([BASE_COORDS.lat, BASE_COORDS.lon], {icon: baseIcon})
                .addTo(map)
                .bindPopup('<b>🏭 Base de surveillance</b><br>Point central de monitoring');

            // Cercles de zones de surveillance
            // Zone de surveillance générale (5km) - vert transparent
            L.circle([BASE_COORDS.lat, BASE_COORDS.lon], {
                color: '#28a745',
                fillColor: '#28a745',
                fillOpacity: 0.1,
                radius: ZONES.SURVEILLANCE,
                weight: 2,
                dashArray: '5, 5'
            }).addTo(map).bindPopup('Zone de surveillance (5km)');

            // Zone de danger (2km) - orange transparent
            L.circle([BASE_COORDS.lat, BASE_COORDS.lon], {
                color: '#fd7e14',
                fillColor: '#fd7e14',
                fillOpacity: 0.15,
                radius: ZONES.DANGER,
                weight: 2
            }).addTo(map).bindPopup('Zone de danger (2km)');

            // Zone d'alerte critique (1km) - rouge transparent
            L.circle([BASE_COORDS.lat, BASE_COORDS.lon], {
                color: '#dc3545',
                fillColor: '#dc3545',
                fillOpacity: 0.2,
                radius: ZONES.ALERTE,
                weight: 3
            }).addTo(map).bindPopup('Zone d\'alerte critique (1km)');

            console.log('✅ Carte initialisée avec les zones de surveillance');
        }

        // Calcul de la distance entre deux points géographiques (formule de Haversine)
        function calculerDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Rayon de la Terre en mètres
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distance en mètres
        }

        // Analyse du niveau de danger d'un navire selon sa distance
        function analyserNavire(navire) {
            const distance = calculerDistance(
                BASE_COORDS.lat, BASE_COORDS.lon,
                navire.latitude, navire.longitude
            );

            let statut = 'normal';
            let couleur = '#28a745'; // Vert par défaut
            let emoji = '';
            let classeCSS = 'navire-normal';
            let classeDistance = 'distance-normal';

            // Détermination du statut selon la distance
            if (distance <= ZONES.ALERTE) {
                statut = 'alerte_critique';
                couleur = '#dc3545'; // Rouge
                emoji = '⚠️';
                classeCSS = 'navire-danger';
                classeDistance = 'distance-danger';
                
                // Affichage du panneau d'attention pour la zone 1km
                afficherPanneauAttention(navire);
                
            } else if (distance <= ZONES.DANGER) {
                statut = 'danger';
                couleur = '#dc3545'; // Rouge
                emoji = '⚠️';
                classeCSS = 'navire-danger';
                classeDistance = 'distance-danger';
                
                // Déclenchement de l'alerte pour la zone 2km
                if (!naviresEnDanger.has(navire.mmsi)) {
                    declencherAlerteDanger(navire);
                    naviresEnDanger.add(navire.mmsi);
                }
            } else {
                // Retirer le navire de la liste des navires en danger s'il sort de la zone
                naviresEnDanger.delete(navire.mmsi);
            }

            return {
                distance: Math.round(distance),
                statut,
                couleur,
                emoji,
                classeCSS,
                classeDistance
            };
        }

        // Affichage du panneau d'attention pour les navires à moins de 1km
        function afficherPanneauAttention(navire) {
            // Éviter d'afficher plusieurs panneaux simultanément
            const panneauExistant = document.getElementById('panneauAttention');
            if (panneauExistant) return;

            console.log('⚠️ Affichage panneau attention pour navire:', navire.shipName);
            
            const panneau = document.createElement('div');
            panneau.id = 'panneauAttention';
            panneau.className = 'panneau-attention';
            panneau.innerHTML = `
                ⚠️ ATTENTION ⚠️<br>
                <div style="margin: 10px 0; font-size: 18px;">
                    Navire "${navire.shipName || 'Inconnu'}" à moins de 1km !
                </div>
                <div style="font-size: 14px; opacity: 0.9;">
                    Distance: ${Math.round(calculerDistance(BASE_COORDS.lat, BASE_COORDS.lon, navire.latitude, navire.longitude))}m
                </div>
            `;
            
            document.body.appendChild(panneau);
            
            // Suppression automatique après 5 secondes
            setTimeout(() => {
                if (document.getElementById('panneauAttention')) {
                    panneau.remove();
                }
            }, 5000);
        }

        // Déclenchement de l'alerte pour les navires à 2km (bannière rouge)
        function declencherAlerteDanger(navire) {
            console.log('🚨 Déclenchement alerte danger pour navire:', navire.shipName);
            
            // Suppression de l'ancienne bannière si elle existe
            const ancienneBanniere = document.getElementById('banniereAlerte');
            if (ancienneBanniere) {
                ancienneBanniere.remove();
            }

            // Création de la bannière d'alerte
            const banniere = document.createElement('div');
            banniere.id = 'banniereAlerte';
            banniere.className = 'banniere-alerte';
            banniere.innerHTML = `
                🚨 ALERTE DANGER 🚨 - Navire "${navire.shipName || 'Inconnu'}" dans la zone de 2km ! 
                Distance: ${Math.round(calculerDistance(BASE_COORDS.lat, BASE_COORDS.lon, navire.latitude, navire.longitude))}m
            `;
            
            document.body.insertBefore(banniere, document.body.firstChild);
            
            // Suppression automatique après 10 secondes
            setTimeout(() => {
                if (document.getElementById('banniereAlerte')) {
                    banniere.remove();
                }
            }, 10000);

            // Notification sonore (si le navigateur le permet)
            try {
                // Création d'un bip sonore d'alerte
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('🔇 Notification sonore non disponible');
            }
        }

        // Mise à jour des marqueurs sur la carte
        function mettreAJourMarqueurs() {
            console.log('🗺️ Mise à jour des marqueurs sur la carte');
            
            // Suppression des anciens marqueurs
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Ajout des nouveaux marqueurs pour chaque navire
            navires.forEach(navire => {
                const analyse = analyserNavire(navire);
                
                // Création de l'icône du navire avec couleur selon la distance
                const iconeNavire = L.divIcon({
                    html: `<div style="
                        background-color: ${analyse.couleur};
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        border: 2px solid white;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 10px;
                    ">🚢</div>${analyse.emoji ? `<span style="position: absolute; top: -10px; right: -10px; font-size: 16px;">${analyse.emoji}</span>` : ''}`,
                    iconSize: [20, 20],
                    className: 'navire-marker'
                });

                // Création du popup avec informations détaillées
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h4 style="margin: 0 0 10px 0; color: ${analyse.couleur};">
                            🚢 ${navire.shipName || 'Navire inconnu'} ${analyse.emoji}
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 12px;">
                            <div><strong>Vitesse:</strong> ${navire.speed || 'N/A'} kn</div>
                            <div><strong>Longueur:</strong> ${navire.length || 'N/A'} m</div>
                            <div><strong>MMSI:</strong> ${navire.mmsi || 'N/A'}</div>
                            <div><strong>Type:</strong> ${navire.shipType || 'N/A'}</div>
                            <div><strong>Distance:</strong> ${analyse.distance}m</div>
                            <div><strong>Statut:</strong> <span style="color: ${analyse.couleur}; font-weight: bold;">${analyse.statut.toUpperCase()}</span></div>
                        </div>
                        <div style="margin-top: 8px; font-size: 11px; color: #666;">
                            📍 ${navire.latitude?.toFixed(6)}, ${navire.longitude?.toFixed(6)}
                        </div>
                    </div>
                `;

                // Ajout du marqueur à la carte
                const marker = L.marker([navire.latitude, navire.longitude], {icon: iconeNavire})
                    .addTo(map)
                    .bindPopup(popupContent);
                
                markers.push(marker);
            });

            console.log(`✅ ${markers.length} marqueurs ajoutés à la carte`);
        }

        // Mise à jour de la liste des navires dans la sidebar
        function mettreAJourListeNavires() {
            console.log('📋 Mise à jour de la liste des navires');
            
            const listeElement = document.getElementById('listeNavires');
            
            if (navires.length === 0) {
                listeElement.innerHTML = '<div class="loading">Aucun navire détecté dans la zone</div>';
                return;
            }

            // Tri des navires par distance (les plus proches en premier)
            const naviresTries = [...navires].sort((a, b) => {
                const distA = calculerDistance(BASE_COORDS.lat, BASE_COORDS.lon, a.latitude, a.longitude);
                const distB = calculerDistance(BASE_COORDS.lat, BASE_COORDS.lon, b.latitude, b.longitude);
                return distA - distB;
            });

            // Génération du HTML pour chaque navire
            const htmlNavires = naviresTries.map(navire => {
                const analyse = analyserNavire(navire);
                
                return `
                    <div class="navire-item ${analyse.classeCSS}" onclick="centrerSurNavire(${navire.latitude}, ${navire.longitude})">
                        <div class="navire-header">
                            <span class="navire-nom">
                                🚢 ${navire.shipName || 'Navire inconnu'} ${analyse.emoji}
                            </span>
                            <span class="navire-distance ${analyse.classeDistance}">
                                ${analyse.distance}m
                            </span>
                        </div>
                        <div class="navire-details">
                            <div class="navire-detail">
                                <span>Vitesse:</span>
                                <strong>${navire.speed || 'N/A'} kn</strong>
                            </div>
                            <div class="navire-detail">
                                <span>Longueur:</span>
                                <strong>${navire.length || 'N/A'} m</strong>
                            </div>
                            <div class="navire-detail">
                                <span>MMSI:</span>
                                <strong>${navire.mmsi || 'N/A'}</strong>
                            </div>
                            <div class="navire-detail">
                                <span>Type:</span>
                                <strong>${navire.shipType || 'N/A'}</strong>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            listeElement.innerHTML = htmlNavires;
        }

        // Centrage de la carte sur un navire spécifique
        function centrerSurNavire(lat, lon) {
            console.log(`🎯 Centrage sur navire: ${lat}, ${lon}`);
            map.setView([lat, lon], 15);
        }

        // Mise à jour des statistiques
        function mettreAJourStatistiques() {
            console.log('📊 Mise à jour des statistiques');
            
            let normaux = 0, danger = 0, alerte = 0;
            
            navires.forEach(navire => {
                const analyse = analyserNavire(navire);
                switch(analyse.statut) {
                    case 'normal': normaux++; break;
                    case 'danger': danger++; break;
                    case 'alerte_critique': alerte++; break;
                }
            });

            // Mise à jour des éléments HTML
            document.getElementById('totalNavires').textContent = navires.length;
            document.getElementById('naviresNormaux').textContent = normaux;
            document.getElementById('naviresDanger').textContent = danger;
            document.getElementById('naviresAlerte').textContent = alerte;
            document.getElementById('derniereMaj').textContent = new Date().toLocaleTimeString('fr-FR');
        }

        // Récupération des données depuis l'API EuRIS via le proxy
        async function recupererNavires() {
            console.log('🔄 Récupération des navires depuis EuRIS...');
            
            const token = document.getElementById('token').value;
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            const rayon = parseFloat(document.getElementById('rayon').value);

            if (!token) {
                throw new Error('Token API requis');
            }

            // Calcul de la bounding box pour la zone de surveillance
            const kmToDegrees = rayon / 111; // Approximation: 1 degré ≈ 111 km
            const minLat = lat - kmToDegrees;
            const maxLat = lat + kmToDegrees;
            const minLon = lon - (kmToDegrees / Math.cos(lat * Math.PI / 180));
            const maxLon = lon + (kmToDegrees / Math.cos(lat * Math.PI / 180));

            // Appel à la fonction serverless Netlify
            const url = `/.netlify/functions/euris-proxy?minLat=${minLat}&maxLat=${maxLat}&minLon=${minLon}&maxLon=${maxLon}&token=${encodeURIComponent(token)}&pageSize=100`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`Erreur API: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }

            // Filtrage des navires dans la zone de surveillance (5km)
            const naviresFiltrés = (data.tracks || []).filter(navire => {
                const distance = calculerDistance(lat, lon, navire.latitude, navire.longitude);
                return distance <= ZONES.SURVEILLANCE;
            });

            console.log(`✅ ${naviresFiltrés.length} navires récupérés dans la zone de ${rayon}km`);
            return naviresFiltrés;
        }

        // Mise à jour complète des données
        async function mettreAJourDonnees() {
            try {
                console.log('🔄 Début de la mise à jour des données');
                
                // Récupération des nouveaux données
                navires = await recupererNavires();
                
                // Mise à jour de tous les éléments de l'interface
                mettreAJourMarqueurs();
                mettreAJourListeNavires();
                mettreAJourStatistiques();
                
                console.log('✅ Mise à jour terminée avec succès');
                
            } catch (error) {
                console.error('❌ Erreur lors de la mise à jour:', error);
                
                // Affichage de l'erreur dans l'interface
                document.getElementById('listeNavires').innerHTML = `
                    <div class="error">
                        <strong>Erreur de récupération:</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // Gestion du compteur de rafraîchissement automatique
        function demarrerCompteur() {
            const compteurElement = document.getElementById('compteurRefresh');
            const tempsElement = document.getElementById('tempsRestant');
            
            compteurElement.style.display = 'block';
            
            intervalleCompteur = setInterval(() => {
                tempsElement.textContent = tempsRestant;
                tempsRestant--;
                
                if (tempsRestant < 0) {
                    tempsRestant = 10; // Reset du compteur
                    mettreAJourDonnees(); // Mise à jour des données
                }
            }, 1000);
        }

        // Arrêt de la surveillance
        function arreterSurveillance() {
            console.log('⏹️ Arrêt de la surveillance');
            
            surveillanceActive = false;
            
            // Arrêt des intervalles
            if (intervalleRefresh) {
                clearInterval(intervalleRefresh);
            }
            if (intervalleCompteur) {
                clearInterval(intervalleCompteur);
            }
            
            // Masquage du compteur
            document.getElementById('compteurRefresh').style.display = 'none';
            
            // Nettoyage des alertes actives
            naviresEnDanger.clear();
            
            // Suppression des bannières d'alerte
            const banniere = document.getElementById('banniereAlerte');
            if (banniere) banniere.remove();
            
            const panneau = document.getElementById('panneauAttention');
            if (panneau) panneau.remove();
        }

        // Démarrage de la surveillance (fonction appelée par le bouton)
        async function demarrerSurveillance() {
            console.log('🚀 Démarrage de la surveillance automatique');
            
            // Arrêt de la surveillance précédente si active
            if (surveillanceActive) {
                arreterSurveillance();
            }
            
            try {
                // Première récupération immédiate
                await mettreAJourDonnees();
                
                // Activation de la surveillance
                surveillanceActive = true;
                
                // Démarrage du compteur de rafraîchissement (10 secondes)
                tempsRestant = 10;
                demarrerCompteur();
                
                console.log('✅ Surveillance démarrée - Actualisation toutes les 10 secondes');
                
            } catch (error) {
                console.error('❌ Erreur lors du démarrage:', error);
                alert('Erreur lors du démarrage de la surveillance: ' + error.message);
            }
        }

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🌟 Initialisation de l\'application de surveillance');
            initMap();
            
            // Gestion de l'arrêt de la surveillance lors de la fermeture de la page
            window.addEventListener('beforeunload', function() {
                if (surveillanceActive) {
                    arreterSurveillance();
                }
            });
            
            console.log('✅ Application initialisée et prête');
        });
    </script>
</body>
</html>
